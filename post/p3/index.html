<html lang="en">
<head>

  
  <meta charset="utf-8">
  <title>用golan进行词法分析，第一部分</title>
  <meta name="description" content="用golan进行词法分析，第一部分">
  <meta name="author" content="">

  
  <meta name="viewport" content="width=device-width, initial-scale=1">

  
  
  
  <link rel="stylesheet" href="http://smithfox.github.io//css/fonts.css">
  <link rel="stylesheet" href="http://smithfox.github.io//css/normalize.css">
  <link rel="stylesheet" href="http://smithfox.github.io//css/skeleton.css">
  <link rel="stylesheet" href="http://smithfox.github.io//css/custom.css">

  
  
  <link rel="stylesheet" href="http://smithfox.github.io//highlight/styles/monokai_sublime.css">
  
  <script src="http://smithfox.github.io//highlight/highlight.pack.js"></script>
  <script>hljs.initHighlightingOnLoad();</script>

</head>
<body>

<header id="menu">
  <div class="container">
	<span class="logo">SmithFox Blog</span>
	<a>&#9776;</a>
  </div>
</header>

<nav class="navbar">
  <div class="container">
	<div class="row">
	  <div class="eight columns offset-by-two">
		<ul class="">
		  
		  <li class="u-pull-left"> <a href="http://smithfox.github.io/" class="brand" style="font-weight:bold;font-size:normal"> SmithFox Blog </a></li>
		  <li class="u-pull-right cate"> <a href="http://smithfox.github.io//about/" class=""> About </a></li>
		  
		  <li class="u-pull-right cate"> <a href="http://smithfox.github.io//categories/html" class=""> Html </a></li>
		  
		  <li class="u-pull-right cate"> <a href="http://smithfox.github.io//categories/%E5%85%B6%E4%BB%96" class=""> 其他 </a></li>
		  
		  <li class="u-pull-right cate"> <a href="http://smithfox.github.io//categories/%E7%BC%96%E7%A8%8B%E8%AF%AD%E8%A8%80" class=""> 编程语言 </a></li>
		  
		</ul>
	  </div>
	</div>
  </div>
</nav>


<div class="container post-wrapper">
  <div class="row">
	<div class="eight columns offset-by-two">
	  <div id="post-title">
		<h5>用golan进行词法分析，第一部分</h5>
		<p class="footnote">
		  
		  <time class="">2015-05-26</time>
		  
		  
		  |&nbsp;&nbsp;
		  
		  
		  &nbsp;标签:[<a href="http://smithfox.github.io//tags/golan">golan</a> <a href="http://smithfox.github.io//tags/lexer">lexer</a> <a href="http://smithfox.github.io//tags/token">token</a> ]
		  

		  
		  &nbsp;分类:[<a href="http://smithfox.github.io//categories/%E7%BC%96%E7%A8%8B%E8%AF%AD%E8%A8%80">编程语言</a> ]
		  

		  
		  &nbsp;系列:[<a href="http://smithfox.github.io//series/%E7%BC%96%E8%AF%91%E5%AE%9E%E6%88%98">编译实战</a> ]
		  
		</p>
	  </div>

	  <div class="post">
		

<h3 id="主要步骤:3338874448cf36f2056dd96b34bbe8b9">主要步骤</h3>

<ol>
<li>词法分析(lexical parse或是lexical scan) 得到 token</li>
<li>语法分析(syntax parse)得到AST(syntax tree)</li>
<li>语义分析(semantic parse)修改AST</li>
</ol>

<h3 id="词法分析常见问题:3338874448cf36f2056dd96b34bbe8b9">词法分析常见问题</h3>

<ol>
<li><p>输入内容编码问题: 可能有汉字
&gt; 词法分析前，都转换为utf-8，要注意utf-8的BOM问题</p></li>

<li><p>源文件不止一个，如何组织
&gt; 一般是抽象File和FileSet，但这个File和io.File不一样</p></li>

<li><p>怎么让处理错误? 推出逻辑和显示
&gt; 需要知道是哪个文件，哪行哪列</p></li>

<li><p>转义问题</p></li>

<li><p>数的词法，其他进制(8进制和16进制)，科学数字表示</p></li>

<li><p>Token如何定义</p></li>
</ol>

<h3 id="先来一个简化的词法分析:3338874448cf36f2056dd96b34bbe8b9">先来一个简化的词法分析</h3>

<p>没有源代码文件，直接string源代码。utf-8编码，不处理转义，直接printf错误，只有10进制。
<strong>我们要分析</strong></p>

<pre><code>int ak = 38;
</code></pre>

<p>我们的原则是麻雀虽小五脏俱全</p>

<pre><code class="language-go">package main

import (
	&quot;fmt&quot;
)

const (
	_         int = iota //
	ILLEGAL              //
	EOF                  //
	IDENT                // main
	DECLINT              // int
	NUMBER               // 123
	ASSIGN               // =
	SEMICOLON            // ;
)

var TOKEN_NAMES = [...]string{
	ILLEGAL:   &quot;ILLEGAL&quot;,
	EOF:       &quot;EOF&quot;,
	IDENT:     &quot;IDENT&quot;,
	DECLINT:   &quot;DECLINT&quot;,
	NUMBER:    &quot;NUMBER&quot;,
	ASSIGN:    &quot;ASSIGN&quot;,
	SEMICOLON: &quot;SEMICOLON&quot;,
}

type Token struct {
	TokenType   int
	TokenName   string
	TokenString string
}

func IsKeywordToken(ss string) (int, bool) {
	if ss == &quot;int&quot; {
		return DECLINT, true
	}
	return IDENT, false
}

type Source struct {
	str string
	d0  int
	d1  int
	c   rune
	l   int
}

func (m *Source) next() {
	if m.d1 &lt; m.l {
		m.d0 = m.d1
		m.c = rune(m.str[m.d0])
		m.d1++
	} else {
		m.d0 = m.l
		m.c = -1 // EOF
	}
}

func IsWhiteSpace(chr rune) bool {
	if chr == ' ' || chr == '\t' || chr == '\n' || chr == '\r' {
		return true
	} else {
		return false
	}
}

func (m *Source) skipWhiteSpace() {
	for IsWhiteSpace(m.c) {
		m.next()
	}
}

func IsNumber(chr rune) bool {
	if '0' &lt;= chr &amp;&amp; chr &lt;= '9' {
		return true
	}
	return false
}

func (m *Source) skipNumber() {
	for IsNumber(m.c) {
		m.next()
	}
}

func IsLetter(chr rune) bool {
	if 'a' &lt;= chr &amp;&amp; chr &lt;= 'z' || 'A' &lt;= chr &amp;&amp; chr &lt;= 'Z' {
		return true
	}
	return false
}

func (m *Source) skipLetters() {
	for IsLetter(m.c) {
		m.next()
	}
}

func (m *Source) printf() {
	fmt.Printf(&quot;(d0:%d, d1:%d)\n&quot;, m.d0, m.d1)
}

func main() {
	src := `int ak = 38;`
	source := &amp;Source{str: src, l: len(src), c: rune(src[0])}
	tokens, err := scan(source)
	if err != nil {
		fmt.Printf(&quot;scan err=%v\n&quot;, err)
		return
	}
	show(tokens)
}

func scan(source *Source) ([]*Token, error) {
	tokens := []*Token{}
	n := 0
	for {
		n++
		if n &gt; 100 {
			break
		}
		source.printf()
		source.skipWhiteSpace()
		switch c := source.c; {
		case IsLetter(c):
			d0 := source.d0
			source.skipLetters()
			ss := source.str[d0 : source.d1-1]
			//fmt.Printf(&quot;ss=%s,source.d1=%d,source.d0=%d,d0=%d\n&quot;, ss, source.d1, source.d0, d0)
			tmptoken, iskeyword := IsKeywordToken(ss)
			if iskeyword {
				tokens = append(tokens, &amp;Token{TokenType: tmptoken, TokenName: TOKEN_NAMES[tmptoken], TokenString: ss})
			} else {
				tokens = append(tokens, &amp;Token{TokenType: IDENT, TokenName: TOKEN_NAMES[IDENT], TokenString: ss})
			}
		case IsNumber(c):
			d0 := source.d0
			source.skipNumber()
			ss := source.str[d0 : source.d1-1]
			tokens = append(tokens, &amp;Token{TokenType: NUMBER, TokenName: TOKEN_NAMES[NUMBER], TokenString: ss})
		case c == ';':
			tokens = append(tokens, &amp;Token{TokenType: SEMICOLON, TokenName: TOKEN_NAMES[SEMICOLON], TokenString: &quot;;&quot;})
			source.next()
		case c == '=':
			tokens = append(tokens, &amp;Token{TokenType: ASSIGN, TokenName: TOKEN_NAMES[ASSIGN], TokenString: &quot;=&quot;})
			source.next()
		case c == -1:
			tokens = append(tokens, &amp;Token{TokenType: EOF, TokenName: TOKEN_NAMES[EOF], TokenString: &quot;&quot;})
			goto _exit
		default:
			tokens = append(tokens, &amp;Token{TokenType: ILLEGAL, TokenName: TOKEN_NAMES[ILLEGAL], TokenString: &quot;&quot;})
			goto _exit
		}
	}
_exit:
	return tokens, nil
}

func show(tokens []*Token) {
	for _, token := range tokens {
		fmt.Printf(&quot;[&quot; + token.TokenName + &quot;],&quot;)
	}
	fmt.Printf(&quot;\n--------------------------\n&quot;)
	for _, token := range tokens {
		fmt.Printf(&quot;[&quot; + token.TokenString + &quot;],&quot;)
	}
}

</code></pre>

<p><a href="https://wide.b3log.org/playground/ce2e3f4ea0984c953aebd8223367bb7b.go">play</a></p>

	  </div>
	  <div class="post-comment">
	  <div id="disqus_thread"></div>
<script type="text/javascript">
	var disqus_shortname = "smithfox";

    (function() {
        var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
        dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    })();
</script>
<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript" rel="nofollow">comments powered by Disqus.</a></noscript>

	  </div>
	</div>
  </div>
</div>

<div class="footer">
  <div class="container">
	<div class="row">
	  <div class="ten columns offset-by-two">
		<p class="footnote">
		  Powered by <a href="http://gohugo.io">gohugo</a> |&nbsp;
		  
		  @ 2015 by SmithFox |&nbsp;
		  
		  
		  我在:

		  
		  <a href="https://github.com/smithfox" >GitHub</a>,
		  

		  

		  

		  

		  
		</p>
	  </div>
	</div>
  </div>
</div>


<script src="http://smithfox.github.io//js/jquery.min.js" type="text/javascript"></script>
<script src="http://smithfox.github.io//js/jquery.timeago.js" type="text/javascript"></script>
<script type="text/javascript">
  $(function(){
    $("time.timeago").timeago();
  })
  $("#menu").click(function(){
    $(".brand").text("HOME");
    $(".navbar ul li").removeClass("cate");
    $(".navbar").toggle();
  });
  $(window).resize(function(){
    if(window.innerWidth > 768) {
      $(".navbar").removeAttr("style");
    }
  });
</script>

</body>
</html>

